terraform {
 required_version = ">= 0.13"
  required_providers {
    libvirt = {
      source  = "dmacvicar/libvirt"
      version = "0.6.3"
    }
  }
}

# instance the provider
provider "libvirt" {
  uri = "qemu:///system"
}

#----------CentOS7----------
#---fw---
resource "libvirt_volume" "team1-fw" {
  name   = "team1-fw"
  source = "/terraform-team1/images/team1-fw.qcow2"
  format = "qcow2"
}

resource "libvirt_cloudinit_disk" "cloudinit_team1-fw" {
  name = "team1-fw.iso"
  pool = "default"

  user_data = <<EOF
    #cloud-config
    hostname: team1.fw
    user: tmcit
    password: tmcit
    chpasswd: { expire: True }
    ssh_pwauth: True
    EOF

  network_config = <<EOF
    version: 2
    ethernets:
      eth0:
        match:
          name: ens3
        addresses:
          - 192.168.7.9/24
        gateway4: 192.168.7.254
        nameservers:
          addresses: [1.1.1.1]
    EOF
}

resource "libvirt_domain" "team1-fw" {
  name   = "team1-fw"
  memory = "1024"
  vcpu   = 1

  cloudinit = libvirt_cloudinit_disk.cloudinit_team1-fw.id

  network_interface {
    bridge = "mgmt"
  }

  network_interface {
    bridge = "team1-internet"
  }

  network_interface {
    bridge = "team1-dmz"
  }

  network_interface {
    bridge = "team1-internal"
  }

  network_interface {
    bridge = "team1-client"
  }

  console {
    type        = "pty"
    target_port = "0"
    target_type = "serial"
  }

  console {
    type        = "pty"
    target_type = "virtio"
    target_port = "1"
  }

  disk {
    volume_id    = libvirt_volume.team1-fw.id
  }
}

#---web1---
resource "libvirt_volume" "team1-web1" {
  name   = "team1-web1"
  source = "/terraform-team1/images/team1-ubuntu20.04.qcow2"
  format = "qcow2"
}

resource "libvirt_cloudinit_disk" "cloudinit_team1-web1" {
  name = "team1-web1.iso"
  pool = "default"

  user_data = <<EOF
    #cloud-config
    hostname: team1.web1
    user: tmcit
    password: tmcit
    chpasswd: { expire: True }
    ssh_pwauth: True
    EOF

  network_config = <<EOF
    version: 2
    ethernets:
      eth0:
        match:
          name: ens3
        addresses:
          - 192.168.7.10/24
        gateway4: 192.168.7.254
        nameservers:
          addresses: [1.1.1.1]
    EOF
}

resource "libvirt_domain" "team1-web1" {
  name   = "team1-web1"
  memory = "1024"
  vcpu   = 1

  cloudinit = libvirt_cloudinit_disk.cloudinit_team1-web1.id

  network_interface {
    bridge = "mgmt"
  }

  network_interface {
    bridge = "team1-dmz"
  }

  console {
    type        = "pty"
    target_port = "0"
    target_type = "serial"
  }

  console {
    type        = "pty"
    target_type = "virtio"
    target_port = "1"
  }

  disk {
    volume_id    = libvirt_volume.team1-web1.id
  }
}

#---dns---
resource "libvirt_volume" "team1-dns" {
  name   = "team1-dns"
  source = "/terraform-team1/images/team1-dns.qcow2"
  format = "qcow2"
}

resource "libvirt_cloudinit_disk" "cloudinit_team1-dns" {
  name = "team1dns.iso"
  pool = "default"

  user_data = <<EOF
    #cloud-config
    hostname: team1.dns
    user: tmcit
    password: tmcit
    chpasswd: { expire: True }
    ssh_pwauth: True
    EOF

  network_config = <<EOF
    version: 2
    ethernets:
      eth0:
        match:
          name: ens3
        addresses:
          - 192.168.7.11/24
        gateway4: 192.168.7.254
        nameservers:
          addresses: [1.1.1.1]
    EOF
}

resource "libvirt_domain" "team1-dns" {
  name   = "team1-dns"
  memory = "1024"
  vcpu   = 1

  cloudinit = libvirt_cloudinit_disk.cloudinit_team1-dns.id

  network_interface {
    bridge = "mgmt"
  }

  network_interface {
    bridge = "team1-dmz"
  }

  console {
    type        = "pty"
    target_port = "0"
    target_type = "serial"
  }

  console {
    type        = "pty"
    target_type = "virtio"
    target_port = "1"
  }

  disk {
    volume_id    = libvirt_volume.team1-dns.id
  }
}

#---mail---
resource "libvirt_volume" "team1-mail" {
  name   = "team1-mail"
  source = "/terraform-team1/images/team1-mail.qcow2"
  format = "qcow2"
}

resource "libvirt_cloudinit_disk" "cloudinit_team1-mail" {
  name = "team1mail.iso"
  pool = "default"

  user_data = <<EOF
    #cloud-config
    hostname: team1.mail
    user: tmcit
    password: tmcit
    chpasswd: { expire: True }
    ssh_pwauth: True
    EOF

  network_config = <<EOF
    version: 2
    ethernets:
      eth0:
        match:
          name: ens3
        addresses:
          - 192.168.7.16/24
        gateway4: 192.168.7.254
        nameservers:
          addresses: [1.1.1.1]
    EOF
}

resource "libvirt_domain" "team1-mail" {
  name   = "team1-mail"
  memory = "1024"
  vcpu   = 1

  cloudinit = libvirt_cloudinit_disk.cloudinit_team1-mail.id

  network_interface {
    bridge = "mgmt"
  }

  network_interface {
    bridge = "team1-dmz"
  }

  console {
    type        = "pty"
    target_port = "0"
    target_type = "serial"
  }

  console {
    type        = "pty"
    target_type = "virtio"
    target_port = "1"
  }

  disk {
    volume_id    = libvirt_volume.team1-mail.id
  }
}

#---mgmt---
resource "libvirt_volume" "team1-mgmt" {
  name   = "team1-mgmt"
  source = "/terraform-team1/images/team1-ubuntu20.04.qcow2"
  format = "qcow2"
}

resource "libvirt_cloudinit_disk" "cloudinit_team1-mgmt" {
  name = "team1-mgmt.iso"
  pool = "default"

  user_data = <<EOF
    #cloud-config
    hostname: team1.mgmt
    user: tmcit
    password: tmcit
    chpasswd: { expire: True }
    ssh_pwauth: True
    EOF

  network_config = <<EOF
    version: 2
    ethernets:
      eth0:
        match:
          name: ens3
        addresses:
          - 192.168.7.19/24
        gateway4: 192.168.7.254
        nameservers:
          addresses: [1.1.1.1]
    EOF
}

resource "libvirt_domain" "team1-mgmt" {
  name   = "team1-mgmt"
  memory = "1024"
  vcpu   = 1

  cloudinit = libvirt_cloudinit_disk.cloudinit_team1-mgmt.id

  network_interface {
    bridge = "mgmt"
  }

  console {
    type        = "pty"
    target_port = "0"
    target_type = "serial"
  }

  console {
    type        = "pty"
    target_type = "virtio"
    target_port = "1"
  }

  disk {
    volume_id    = libvirt_volume.team1-mgmt.id
  }
}

#----------Ubuntu20.04----------
#---vpn---
resource "libvirt_volume" "team1-vpn" {
  name   = "team1-vpn"
  source = "/terraform-team1/images/team1-vpn.qcow2"
  format = "qcow2"
}

resource "libvirt_cloudinit_disk" "cloudinit_team1-vpn" {
  name = "team1-vpn.iso"
  pool = "default"

  user_data = <<EOF
    #cloud-config
    hostname: team1.vpn
    user: tmcit
    password: tmcit
    chpasswd: { expire: True }
    ssh_pwauth: True
    EOF

  network_config = <<EOF
    version: 2
    ethernets:
      eth0:
        match:
          name: ens3
        addresses:
          - 192.168.7.12/24
        gateway4: 192.168.7.254
        nameservers:
          addresses: [1.1.1.1]
    EOF
}

resource "libvirt_domain" "team1-vpn" {
  name   = "team1-vpn"
  memory = "1024"
  vcpu   = 1

  cloudinit = libvirt_cloudinit_disk.cloudinit_team1-vpn.id

  network_interface {
    bridge = "mgmt"
  }

  network_interface {
    bridge = "team1-internal"
  }

  console {
    type        = "pty"
    target_port = "0"
    target_type = "serial"
  }

  console {
    type        = "pty"
    target_type = "virtio"
    target_port = "1"
  }

  disk {
    volume_id    = libvirt_volume.team1-vpn.id
  }
}

#---web2---
resource "libvirt_volume" "team1-web2" {
  name   = "team1-web2"
  source = "/terraform-team1/images/team1-web2.qcow2"
  format = "qcow2"
}

resource "libvirt_cloudinit_disk" "cloudinit_team1-web2" {
  name = "team1-web2.iso"
  pool = "default"

  user_data = <<EOF
    #cloud-config
    hostname: team1.web1
    user: tmcit
    password: tmcit
    chpasswd: { expire: True }
    ssh_pwauth: True
    EOF

  network_config = <<EOF
    version: 2
    ethernets:
      eth0:
        match:
          name: ens3
        addresses:
          - 192.168.7.13/24
        gateway4: 192.168.7.254
        nameservers:
          addresses: [1.1.1.1]
    EOF
}

resource "libvirt_domain" "team1-web2" {
  name   = "team1-web2"
  memory = "1024"
  vcpu   = 1

  cloudinit = libvirt_cloudinit_disk.cloudinit_team1-web2.id

  network_interface {
    bridge = "mgmt"
  }

  network_interface {
    bridge = "team1-internal"
  }

  console {
    type        = "pty"
    target_port = "0"
    target_type = "serial"
  }

  console {
    type        = "pty"
    target_type = "virtio"
    target_port = "1"
  }

  disk {
    volume_id    = libvirt_volume.team1-web2.id
  }
}

#---db---
resource "libvirt_volume" "team1-db" {
  name   = "team1-db"
  source = "/terraform-team1/images/team1-db.qcow2"
  format = "qcow2"
}

resource "libvirt_cloudinit_disk" "cloudinit_team1-db" {
  name = "team1-db.iso"
  pool = "default"

  user_data = <<EOF
    #cloud-config
    hostname: team1.db
    user: tmcit
    password: tmcit
    chpasswd: { expire: True }
    ssh_pwauth: True
    EOF

  network_config = <<EOF
    version: 2
    ethernets:
      eth0:
        match:
          name: ens3
        addresses:
          - 192.168.7.14/24
        gateway4: 192.168.7.254
        nameservers:
          addresses: [1.1.1.1]
    EOF
}

resource "libvirt_domain" "team1-db" {
  name   = "team1-db"
  memory = "1024"
  vcpu   = 1

  cloudinit = libvirt_cloudinit_disk.cloudinit_team1-db.id

  network_interface {
    bridge = "mgmt"
  }

  console {
    type        = "pty"
    target_port = "0"
    target_type = "serial"
  }

  console {
    type        = "pty"
    target_type = "virtio"
    target_port = "1"
  }

  disk {
    volume_id    = libvirt_volume.team1-db.id
  }
}

#---other---
resource "libvirt_volume" "team1-other" {
  name   = "team1-other"
  source = "/terraform-team1/images/team1-other.qcow2"
  format = "qcow2"
}

resource "libvirt_cloudinit_disk" "cloudinit_team1-other" {
  name = "team1-other.iso"
  pool = "default"

  user_data = <<EOF
    #cloud-config
    hostname: team1.other
    user: tmcit
    password: tmcit
    chpasswd: { expire: True }
    ssh_pwauth: True
    EOF

  network_config = <<EOF
    version: 2
    ethernets:
      eth0:
        match:
          name: ens3
        addresses:
          - 192.168.7.18/24
        gateway4: 192.168.7.254
        nameservers:
          addresses: [1.1.1.1]
    EOF
}

resource "libvirt_domain" "team1-other" {
  name   = "team1-other"
  memory = "1024"
  vcpu   = 1

  cloudinit = libvirt_cloudinit_disk.cloudinit_team1-other.id

  network_interface {
    bridge = "mgmt"
  }

  network_interface {
    bridge = "team1-internal"
  }

  console {
    type        = "pty"
    target_port = "0"
    target_type = "serial"
  }

  console {
    type        = "pty"
    target_type = "virtio"
    target_port = "1"
  }
  
  graphics {
    type        = "vnc"
    listen_type = "address"
    autoport    = true
  }

  disk {
    volume_id    = libvirt_volume.team1-other.id
  }
}

#---------windows----------
#---windowsserver-2016---
resource "libvirt_volume" "team1-windowsserver" {
  name   = "team1-windowsserver"
  source = "/terraform-team1/images/team1-windowsserver.qcow2"
  format = "qcow2"
}

resource "libvirt_domain" "team1-windowsserver" {
  name   = "team1-windowsserver"
  memory = "4096"
  vcpu   = 2

  network_interface {
    bridge = "mgmt"
  }

  network_interface {
    bridge = "team1-internal"
  }

  console {
    type        = "pty"
    target_port = "0"
    target_type = "serial"
  }

  console {
    type        = "pty"
    target_type = "virtio"
    target_port = "1"
  }
  
  graphics {
    type        = "vnc"
    listen_type = "address"
    autoport    = true
  }

  disk {
    volume_id    = libvirt_volume.team1-windowsserver.id
  }
}

#---windows-10---
resource "libvirt_volume" "team1-windows10" {
  name   = "team1-windows10"
  source = "/terraform-team1/images/team1-windows10.qcow2"
  format = "qcow2"
}

resource "libvirt_domain" "team1-windows10" {
  name   = "team1-windows10"
  memory = "4096"
  vcpu   = 2

  network_interface {
    bridge = "mgmt"
  }

  network_interface {
    bridge = "team1-client"
  }

  console {
    type        = "pty"
    target_port = "0"
    target_type = "serial"
  }

  console {
    type        = "pty"
    target_type = "virtio"
    target_port = "1"
  }
  
  graphics {
    type        = "vnc"
    listen_type = "address"
    autoport    = true
  }

  disk {
    volume_id    = libvirt_volume.team1-windows10.id
  }
}

#---windows-8---
resource "libvirt_volume" "team1-windows8" {
  name   = "team1-windows8"
  source = "/terraform-team1/images/team1-windows10.qcow2"
  format = "qcow2"
}

resource "libvirt_domain" "team1-windows8" {
  name   = "team1-windows8"
  memory = "4096"
  vcpu   = 2

  network_interface {
    bridge = "mgmt"
  }

  network_interface {
    bridge = "team1-client"
  }

  console {
    type        = "pty"
    target_port = "0"
    target_type = "serial"
  }

  console {
    type        = "pty"
    target_type = "virtio"
    target_port = "1"
  }
  
  graphics {
    type        = "vnc"
    listen_type = "address"
    autoport    = true
  }

  disk {
    volume_id    = libvirt_volume.team1-windows8.id
  }
}