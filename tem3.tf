terraform {
 required_version = ">= 0.13"
  required_providers {
    libvirt = {
      source  = "dmacvicar/libvirt"
      version = "0.6.3"
    }
  }
}

# instance the provider
provider "libvirt" {
  uri = "qemu:///system"
}
#----------vyos----------
#---vyos---
resource "libvirt_volume" "team3-vyos" {
  name   = "team3-vyos"
  source = "/terraform-team3/images/team3-vyos.qcow2"
  format = "qcow2"
}

resource "libvirt_domain" "team3-vyos" {
  name   = "team3-vyos"
  memory = "1024"
  vcpu   = 1

  network_interface {
    bridge = "mgmt"
  }

  network_interface {
    bridge = "team3-internet"
  }

  network_interface {
    bridge = "team3-cloud"
  }

  console {
    type        = "pty"
    target_port = "0"
    target_type = "serial"
  }

  console {
    type        = "pty"
    target_type = "virtio"
    target_port = "1"
  }
  
  graphics {
    type        = "vnc"
    listen_type = "address"
    autoport    = true
  }

  disk {
    volume_id    = libvirt_volume.team3-vyos.id
  }
}

#---fw---
resource "libvirt_volume" "team3-fw" {
  name   = "team3-fw"
  source = "/terraform-team3/images/team3-vyos.qcow2"
  format = "qcow2"
}

resource "libvirt_domain" "team3-fw" {
  name   = "team3-fw"
  memory = "1024"
  vcpu   = 1

  network_interface {
    bridge = "mgmt"
  }

  network_interface {
    bridge = "team3-internet"
  }

  network_interface {
    bridge = "team3-internal"
  }

  console {
    type        = "pty"
    target_port = "0"
    target_type = "serial"
  }

  console {
    type        = "pty"
    target_type = "virtio"
    target_port = "1"
  }
  
  graphics {
    type        = "vnc"
    listen_type = "address"
    autoport    = true
  }

  disk {
    volume_id    = libvirt_volume.team3-fw.id
  }
}

#----------CentOS----------
#---web.ex---
resource "libvirt_volume" "team3-web_ex" {
  name   = "team3-web_ex"
  source = "/terraform-team3/images/team3-webex.qcow2"
  format = "qcow2"
}

resource "libvirt_cloudinit_disk" "cloudinit_team3-web_ex" {
  name = "team3-web_ex.iso"
  pool = "default"

  user_data = <<EOF
    #cloud-config
    hostname: team3.webex
    user: tmuser
    password: P@ssw0rd_team3
    chpasswd: { expire: True }
    ssh_pwauth: True
    EOF

  network_config = <<EOF
    version: 2
    ethernets:
      eth0:
        match:
          name: ens3
        addresses:
          - 192.168.7.29/24
        gateway4: 192.168.7.254
        nameservers:
          addresses: [1.1.1.1]
      eth1:
        match:
          name: ens4
        addresses:
          - 10.0.3.2/24
    EOF
}

resource "libvirt_domain" "team3-web_ex" {
  name   = "team3-web_ex"
  memory = "1024"
  vcpu   = 1

  cloudinit = libvirt_cloudinit_disk.cloudinit_team3-web_ex.id

  network_interface {
    bridge = "mgmt"
  }

  network_interface {
    bridge = "team3-cloud"
  }

  console {
    type        = "pty"
    target_port = "0"
    target_type = "serial"
  }

  console {
    type        = "pty"
    target_type = "virtio"
    target_port = "1"
  }

  graphics {
    type        = "vnc"
    listen_type = "address"
    autoport    = true
  }

  disk {
    volume_id    = libvirt_volume.team3-web_ex.id
  }
}

#---web.in---
resource "libvirt_volume" "team3-web_in" {
  name   = "team3-web_in"
  source = "/terraform-team3/images/team3-centos7.qcow2"
  format = "qcow2"
}

resource "libvirt_cloudinit_disk" "cloudinit_team3-web_in" {
  name = "team3-web_in.iso"
  pool = "default"

  user_data = <<EOF
    #cloud-config
    hostname: team3.webin
    user: tmuser
    password: P@ssw0rd_team3
    chpasswd: { expire: True }
    ssh_pwauth: True
    EOF

  network_config = <<EOF
    version: 2
    ethernets:
      eth0:
        match:
          name: ens3
        addresses:
          - 192.168.7.26/24
        gateway4: 192.168.7.254
        nameservers:
          addresses: [1.1.1.1]
      eth1:
        match:
          name: ens4
        addresses:
          - 192.168.0.5/24
    EOF
}

resource "libvirt_domain" "team3-web_in" {
  name   = "team3-web_in"
  memory = "1024"
  vcpu   = 1

  cloudinit = libvirt_cloudinit_disk.cloudinit_team3-web_in.id

  network_interface {
    bridge = "mgmt"
  }

  network_interface {
    bridge = "team3-internal"
  }

  console {
    type        = "pty"
    target_port = "0"
    target_type = "serial"
  }

  console {
    type        = "pty"
    target_type = "virtio"
    target_port = "1"
  }

  disk {
    volume_id    = libvirt_volume.team3-web_in.id
  }
}

#----------ubuntu20.04----------
#---file---
resource "libvirt_volume" "team3-file" {
  name   = "team3-file"
  source = "/terraform-team3/images/team3-ubuntu20.04.qcow2"
  format = "qcow2"
}

resource "libvirt_cloudinit_disk" "cloudinit_team3-file" {
  name = "team3-file.iso"
  pool = "default"

  user_data = <<EOF
    #cloud-config
    hostname: team3.file
    user: tmuser
    password: P@ssw0rd_team3
    chpasswd: { expire: True }
    ssh_pwauth: True
    EOF

  network_config = <<EOF
    version: 2
    ethernets:
      eth0:
        match:
          name: ens3
        addresses:
          - 192.168.7.25/24
        gateway4: 192.168.7.254
        nameservers:
          addresses: [1.1.1.1]
      eth1:
        match:
          name: ens4
        addresses:
          - 192.168.0.4/24
    EOF
}

resource "libvirt_domain" "team3-file" {
  name   = "team3-file"
  memory = "1024"
  vcpu   = 1

  cloudinit = libvirt_cloudinit_disk.cloudinit_team3-file.id

  network_interface {
    bridge = "mgmt"
  }

  network_interface {
    bridge = "team3-internal"
  }

  console {
    type        = "pty"
    target_port = "0"
    target_type = "serial"
  }

  console {
    type        = "pty"
    target_type = "virtio"
    target_port = "1"
  }

  disk {
    volume_id    = libvirt_volume.team3-file.id
  }
}

#---vpn---
resource "libvirt_volume" "team3-vpn" {
  name   = "team3-vpn"
  source = "/terraform-team3/images/team3-ubuntu20.04.qcow2"
  format = "qcow2"
}

resource "libvirt_cloudinit_disk" "cloudinit_team3-vpn" {
  name = "team3-vpn.iso"
  pool = "default"

  user_data = <<EOF
    #cloud-config
    hostname: team3.vpn
    user: tmuser
    password: P@ssw0rd_team3
    chpasswd: { expire: True }
    ssh_pwauth: True
    EOF

  network_config = <<EOF
    version: 2
    ethernets:
      eth0:
        match:
          name: ens3
        addresses:
          - 192.168.7.27/24
        gateway4: 192.168.7.254
        nameservers:
          addresses: [1.1.1.1]
      eth1:
        match:
          name: ens4
        addresses:
          - 192.168.0.6/24
    EOF
}

resource "libvirt_domain" "team3-vpn" {
  name   = "team3-vpn"
  memory = "1024"
  vcpu   = 1

  cloudinit = libvirt_cloudinit_disk.cloudinit_team3-vpn.id

  network_interface {
    bridge = "mgmt"
  }

  network_interface {
    bridge = "team3-internal"
  }

  console {
    type        = "pty"
    target_port = "0"
    target_type = "serial"
  }

  console {
    type        = "pty"
    target_type = "virtio"
    target_port = "1"
  }

  disk {
    volume_id    = libvirt_volume.team3-vpn.id
  }
}

#---dns---
resource "libvirt_volume" "team3-dns" {
  name   = "team3-dns"
  source = "/terraform-team3/images/team3-ubuntu20.04.qcow2"
  format = "qcow2"
}

resource "libvirt_cloudinit_disk" "cloudinit_team3-dns" {
  name = "team3-dns.iso"
  pool = "default"

  user_data = <<EOF
    #cloud-config
    hostname: team3.dns
    user: tmuser
    password: P@ssw0rd_team3
    chpasswd: { expire: True }
    ssh_pwauth: True
    EOF

  network_config = <<EOF
    version: 2
    ethernets:
      eth0:
        match:
          name: ens3
        addresses:
          - 192.168.7.30/24
        gateway4: 192.168.7.254
        nameservers:
          addresses: [1.1.1.1]
      eth1:
        match:
          name: ens4
        addresses:
          - 10.0.3.3/24
    EOF
}

resource "libvirt_domain" "team3-dns" {
  name   = "team3-dns"
  memory = "1024"
  vcpu   = 1

  cloudinit = libvirt_cloudinit_disk.cloudinit_team3-dns.id

  network_interface {
    bridge = "mgmt"
  }

  network_interface {
    bridge = "team3-cloud"
  }

  console {
    type        = "pty"
    target_port = "0"
    target_type = "serial"
  }

  console {
    type        = "pty"
    target_type = "virtio"
    target_port = "1"
  }

  disk {
    volume_id    = libvirt_volume.team3-dns.id
  }
}

#---mail---
resource "libvirt_volume" "team3-mail" {
  name   = "team3-mail"
  source = "/terraform-team3/images/team3-ubuntu20.04.qcow2"
  format = "qcow2"
}

resource "libvirt_cloudinit_disk" "cloudinit_team3-mail" {
  name = "team3-mail.iso"
  pool = "default"

  user_data = <<EOF
    #cloud-config
    hostname: team3.mail
    user: tmuser
    password: P@ssw0rd_team3
    chpasswd: { expire: True }
    ssh_pwauth: True
    EOF

  network_config = <<EOF
    version: 2
    ethernets:
      eth0:
        match:
          name: ens3
        addresses:
          - 192.168.7.31/24
        gateway4: 192.168.7.254
        nameservers:
          addresses: [1.1.1.1]
      eth1:
        match:
          name: ens4
        addresses:
          - 10.0.3.4/24
    EOF
}

resource "libvirt_domain" "team3-mail" {
  name   = "team3-mail"
  memory = "1024"
  vcpu   = 1

  cloudinit = libvirt_cloudinit_disk.cloudinit_team3-mail.id

  network_interface {
    bridge = "mgmt"
  }

  network_interface {
    bridge = "team3-cloud"
  }

  console {
    type        = "pty"
    target_port = "0"
    target_type = "serial"
  }

  console {
    type        = "pty"
    target_type = "virtio"
    target_port = "1"
  }

  disk {
    volume_id    = libvirt_volume.team3-mail.id
  }
}

#----------windows----------
#---windows server2019---
resource "libvirt_volume" "team3-windowsserver" {
  name   = "team3-windowsserver"
  source = "/terraform-team3/images/team3-windowsserver.qcow2"
  format = "qcow2"
}

resource "libvirt_domain" "team3-windowsserver" {
  name   = "team3-windowsserver"
  memory = "8096"
  vcpu   = 4

  network_interface {
    bridge = "mgmt"
  }

  network_interface {
    bridge = "team3-internal"
  }

  console {
    type        = "pty"
    target_port = "0"
    target_type = "serial"
  }

  console {
    type        = "pty"
    target_type = "virtio"
    target_port = "1"
  }
  
  graphics {
    type        = "vnc"
    listen_type = "address"
    autoport    = true
  }

  disk {
    volume_id    = libvirt_volume.team3-windowsserver.id
  }
}

#---windows10---
resource "libvirt_volume" "team3-windows10" {
  name   = "team3-windows10"
  source = "/terraform-team3/images/team3-windows10.qcow2"
  format = "qcow2"
}

resource "libvirt_domain" "team3-windows10" {
  name   = "team3-windows10"
  memory = "4096"
  vcpu   = 4

  network_interface {
    bridge = "mgmt"
  }

  network_interface {
    bridge = "team3-internal"
  }

  console {
    type        = "pty"
    target_port = "0"
    target_type = "serial"
  }

  console {
    type        = "pty"
    target_type = "virtio"
    target_port = "1"
  }
  
  graphics {
    type        = "vnc"
    listen_type = "address"
    autoport    = true
  }

  disk {
    volume_id    = libvirt_volume.team3-windows10.id
  }
}