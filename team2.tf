terraform {
 required_version = ">= 0.13"
  required_providers {
    libvirt = {
      source  = "dmacvicar/libvirt"
      version = "0.6.3"
    }
  }
}

# instance the provider
provider "libvirt" {
  uri = "qemu:///system"
}

#----------vyos----------
#---vyos---
resource "libvirt_volume" "team2-vyos" {
  name   = "team2-vyos"
  source = "/terraform-team2/images/team2-vyos.qcow2"
  format = "qcow2"
}

resource "libvirt_domain" "team2-vyos" {
  name   = "team2-vyos"
  memory = "1024"
  vcpu   = 1

  network_interface {
    bridge = "mgmt"
  }

  network_interface {
    bridge = "team2-internet"
  }

  network_interface {
    bridge = "team2-internal"
  }

  network_interface {
    bridge = "team2-client"
  }
  console {
    type        = "pty"
    target_port = "0"
    target_type = "serial"
  }

  console {
    type        = "pty"
    target_type = "virtio"
    target_port = "1"
  }
  
  graphics {
    type        = "vnc"
    listen_type = "address"
    autoport    = true
  }

  disk {
    volume_id    = libvirt_volume.team2-vyos.id
  }
}

#----------ubuntu----------
#---cloud---
resource "libvirt_volume" "team2-cloud" {
  name   = "team2-cloud"
  source = "/terraform-team2/images/team2-cloud.qcow2"
  format = "qcow2"
}

resource "libvirt_cloudinit_disk" "cloudinit_team2-cloud" {
  name = "team2-cloud.iso"
  pool = "default"

  user_data = <<EOF
    #cloud-config
    hostname: team2.cloud
    user: tmcit
    password: tmcit
    chpasswd: { expire: True }
    ssh_pwauth: True
    EOF

  network_config = <<EOF
    version: 2
    ethernets:
      eth0:
        match:
          name: ens3
        addresses:
          - 192.168.7.2/24
        gateway4: 192.168.7.254
        nameservers:
          addresses: [1.1.1.1]
    EOF
}

resource "libvirt_domain" "team2-cloud" {
  name   = "team2-cloud"
  memory = "16384"
  vcpu   = 8

  cloudinit = libvirt_cloudinit_disk.cloudinit_team2-cloud.id

  network_interface {
    bridge = "mgmt"
  }

  network_interface {
    bridge = "team2-internet"
  }

  console {
    type        = "pty"
    target_port = "0"
    target_type = "serial"
  }

  console {
    type        = "pty"
    target_type = "virtio"
    target_port = "1"
  }

  disk {
    volume_id    = libvirt_volume.team2-cloud.id
  }
}
#---web_ex---
resource "libvirt_volume" "team2-web_ex" {
  name   = "team2-web_ex"
  source = "/terraform-team2/images/team2-web_ex.qcow2"
  format = "qcow2"
}

resource "libvirt_domain" "team2-web_ex" {
  name   = "team2-web_ex"
  memory = "2048"
  vcpu   = 1

  network_interface {
    bridge = "mgmt"
  }

  network_interface {
    bridge = "team2-internet"
  }

  console {
    type        = "pty"
    target_port = "0"
    target_type = "serial"
  }

  console {
    type        = "pty"
    target_type = "virtio"
    target_port = "1"
  }

  disk {
    volume_id    = libvirt_volume.team2-web_ex.id
  }
}

#---client2---
resource "libvirt_volume" "team2-client2" {
  name   = "team2-client2"
  source = "/terraform-team2/images/team2-client2.qcow2"
  format = "qcow2"
}

resource "libvirt_cloudinit_disk" "cloudinit_team2-client2" {
  name = "team2-client2.iso"
  pool = "default"

  user_data = <<EOF
    #cloud-config
    hostname: team2.client2
    user: tmcit
    password: tmcit
    chpasswd: { expire: True }
    ssh_pwauth: True
    EOF

  network_config = <<EOF
    version: 2
    ethernets:
      eth0:
        match:
          name: ens3
        addresses:
          - 192.168.7.8/24
        gateway4: 192.168.7.254
        nameservers:
          addresses: [1.1.1.1]
    EOF
}

resource "libvirt_domain" "team2-client2" {
  name   = "team2-client2"
  memory = "1024"
  vcpu   = 1

  cloudinit = libvirt_cloudinit_disk.cloudinit_team2-client2.id

  network_interface {
    bridge = "mgmt"
  }

  network_interface {
    bridge = "team2-client"
  }

  console {
    type        = "pty"
    target_port = "0"
    target_type = "serial"
  }

  console {
    type        = "pty"
    target_type = "virtio"
    target_port = "1"
  }
  
  graphics {
    type        = "vnc"
    listen_type = "address"
    autoport    = true
  }

  disk {
    volume_id    = libvirt_volume.team2-client2.id
  }
}

#----------centos----------
#---web---
resource "libvirt_volume" "team2-web" {
  name   = "team2-web"
  source = "/terraform-team2/images/team2-web.qcow2"
  format = "qcow2"
}

resource "libvirt_cloudinit_disk" "cloudinit_team2-web" {
  name = "team2-web.iso"
  pool = "default"

  user_data = <<EOF
    #cloud-config
    hostname: team2.web
    user: tmcit
    password: tmcit
    chpasswd: { expire: True }
    ssh_pwauth: True
    EOF

  network_config = <<EOF
    version: 2
    ethernets:
      eth0:
        match:
          name: ens3
        addresses:
          - 192.168.7.3/24
        gateway4: 192.168.7.254
        nameservers:
          addresses: [1.1.1.1]
    EOF
}

resource "libvirt_domain" "team2-web" {
  name   = "team2-web"
  memory = "2048"
  vcpu   = 2

  cloudinit = libvirt_cloudinit_disk.cloudinit_team2-web.id

  network_interface {
    bridge = "mgmt"
  }

  network_interface {
    bridge = "team2-internal"
  }

  console {
    type        = "pty"
    target_port = "0"
    target_type = "serial"
  }

  console {
    type        = "pty"
    target_type = "virtio"
    target_port = "1"
  }
  
  graphics {
    type        = "vnc"
    listen_type = "address"
    autoport    = true
  }

  disk {
    volume_id    = libvirt_volume.team2-web.id
  }
}

#---ntp---
resource "libvirt_volume" "team2-ntp" {
  name   = "team2-ntp"
  source = "/terraform-team2/images/team2-ntp.qcow2"
  format = "qcow2"
}

resource "libvirt_cloudinit_disk" "cloudinit_team2-ntp" {
  name = "team2-ntp.iso"
  pool = "default"

  user_data = <<EOF
    #cloud-config
    hostname: team2.ntp
    user: tmcit
    password: tmcit
    chpasswd: { expire: True }
    ssh_pwauth: True
    EOF

  network_config = <<EOF
    version: 2
    ethernets:
      eth0:
        match:
          name: ens3
        addresses:
          - 192.168.7.5/24
        gateway4: 192.168.7.254
        nameservers:
          addresses: [1.1.1.1]
    EOF
}

resource "libvirt_domain" "team2-ntp" {
  name   = "team2-ntp"
  memory = "1024"
  vcpu   = 1

  cloudinit = libvirt_cloudinit_disk.cloudinit_team2-ntp.id

  network_interface {
    bridge = "mgmt"
  }

  network_interface {
    bridge = "team2-internal"
  }

  console {
    type        = "pty"
    target_port = "0"
    target_type = "serial"
  }

  console {
    type        = "pty"
    target_type = "virtio"
    target_port = "1"
  }
  
  graphics {
    type        = "vnc"
    listen_type = "address"
    autoport    = true
  }

  disk {
    volume_id    = libvirt_volume.team2-ntp.id
  }
}

#---log---
resource "libvirt_volume" "team2-log" {
  name   = "team2-log"
  source = "/terraform-team2/images/team2-log.qcow2"
  format = "qcow2"
}

resource "libvirt_cloudinit_disk" "cloudinit_team2-log" {
  name = "team2-log.iso"
  pool = "default"

  user_data = <<EOF
    #cloud-config
    hostname: team2.log
    user: tmcit
    password: tmcit
    chpasswd: { expire: True }
    ssh_pwauth: True
    EOF

  network_config = <<EOF
    version: 2
    ethernets:
      eth0:
        match:
          name: ens3
        addresses:
          - 192.168.7.6/24
        gateway4: 192.168.7.254
        nameservers:
          addresses: [1.1.1.1]
    EOF
}

resource "libvirt_domain" "team2-log" {
  name   = "team2-log"
  memory = "1024"
  vcpu   = 1

  cloudinit = libvirt_cloudinit_disk.cloudinit_team2-log.id

  network_interface {
    bridge = "mgmt"
  }

  network_interface {
    bridge = "team2-internal"
  }

  console {
    type        = "pty"
    target_port = "0"
    target_type = "serial"
  }

  console {
    type        = "pty"
    target_type = "virtio"
    target_port = "1"
  }
  
  graphics {
    type        = "vnc"
    listen_type = "address"
    autoport    = true
  }

  disk {
    volume_id    = libvirt_volume.team2-log.id
  }
}

#----------windows----------
#---windows server---
resource "libvirt_volume" "team2-windowsserver" {
  name   = "team2-windowsserver"
  source = "/terraform-team2/images/team2-windowsserver.qcow2"
  format = "qcow2"
}

resource "libvirt_domain" "team2-windowsserver" {
  name   = "team2-windowsserver"
  memory = "8096"
  vcpu   = 4

  network_interface {
    bridge = "mgmt"
  }

  network_interface {
    bridge = "team2-internal"
  }

  console {
    type        = "pty"
    target_port = "0"
    target_type = "serial"
  }

  console {
    type        = "pty"
    target_type = "virtio"
    target_port = "1"
  }
  
  graphics {
    type        = "vnc"
    listen_type = "address"
    autoport    = true
  }

  disk {
    volume_id    = libvirt_volume.team2-windowsserver.id
  }
}

#---client1---
resource "libvirt_volume" "team2-client1" {
  name   = "team2-client1"
  source = "/terraform-team2/images/team2-client1.qcow2"
  format = "qcow2"
}

resource "libvirt_domain" "team2-client1" {
  name   = "team2-client1"
  memory = "4096"
  vcpu   = 2

  network_interface {
    bridge = "mgmt"
  }

  network_interface {
    bridge = "team2-client"
  }

  console {
    type        = "pty"
    target_port = "0"
    target_type = "serial"
  }

  console {
    type        = "pty"
    target_type = "virtio"
    target_port = "1"
  }
  
  graphics {
    type        = "vnc"
    listen_type = "address"
    autoport    = true
  }

  disk {
    volume_id    = libvirt_volume.team2-client1.id
  }
}